<?xml version="1.0" encoding="UTF-8"?>

<?import javafx.collections.FXCollections?>
<?import javafx.geometry.Insets?>
<?import javafx.scene.control.*?>
<?import javafx.scene.layout.*?>
<?import javafx.scene.text.*?>
<?import java.lang.String?>

<!-- Backup Content Panel - loaded into MainController's content area -->
<VBox xmlns:fx="http://javafx.com/fxml" 
      fx:controller="com.backupforce.ui.BackupController"
      spacing="0"
      stylesheets="@../css/backupforce-modern.css">
    
    <!-- Page Header with Status -->
    <HBox styleClass="status-bar" spacing="12" alignment="CENTER_LEFT">
        <Label text="Data Backup" styleClass="page-header-title"/>
        <Region HBox.hgrow="ALWAYS"/>
        <Label fx:id="selectionCountLabel" text="0 objects selected" styleClass="status-text"/>
        <Label fx:id="apiLimitsLabel" text="API: --/--" styleClass="status-text" style="-fx-opacity: 0.7;"/>
    </HBox>
    
    <!-- Main Split Pane -->
    <SplitPane dividerPositions="0.55" VBox.vgrow="ALWAYS" style="-fx-background-color: transparent;">
        
        <!-- LEFT: Object Selection -->
        <VBox spacing="12" styleClass="content-area">
            
            <!-- Search and Actions -->
            <HBox spacing="12" alignment="CENTER_LEFT">
                <TextField fx:id="searchField" promptText="ðŸ” Search objects..." 
                           HBox.hgrow="ALWAYS" styleClass="form-input"/>
                <Button fx:id="selectAllButton" text="Select All" onAction="#handleSelectAll" 
                        styleClass="btn btn-ghost btn-sm"/>
                <Button fx:id="deselectAllButton" text="Clear" onAction="#handleDeselectAll" 
                        styleClass="btn btn-ghost btn-sm"/>
            </HBox>
            
            <!-- Object Selection Table -->
            <TableView fx:id="allObjectsTable" VBox.vgrow="ALWAYS" styleClass="data-table">
                <columns>
                    <TableColumn fx:id="allSelectColumn" text="" prefWidth="40" 
                                minWidth="40" maxWidth="40"/>
                    <TableColumn fx:id="allNameColumn" text="API Name" prefWidth="170" 
                                minWidth="120"/>
                    <TableColumn fx:id="allLabelColumn" text="Label" prefWidth="150" 
                                minWidth="100"/>
                    <TableColumn fx:id="allFieldsColumn" text="Fields" prefWidth="70" 
                                minWidth="70" maxWidth="70"/>
                    <TableColumn fx:id="allStatusColumn" text="Status" prefWidth="140" 
                                minWidth="100"/>
                </columns>
                <columnResizePolicy>
                    <TableView fx:constant="CONSTRAINED_RESIZE_POLICY"/>
                </columnResizePolicy>
            </TableView>
            
            <!-- Status Tabs (shown during/after backup) -->
            <TabPane fx:id="statusTabPane" VBox.vgrow="ALWAYS" tabClosingPolicy="UNAVAILABLE" 
                     visible="false" managed="false" styleClass="status-tabs">
                <Tab text="All Objects" closable="false">
                    <TableView fx:id="allStatusTable" styleClass="data-table">
                        <columns>
                            <TableColumn fx:id="statusAllNameColumn" text="Object" prefWidth="160"/>
                            <TableColumn fx:id="statusAllLabelColumn" text="Label" prefWidth="160"/>
                            <TableColumn fx:id="statusAllStatusColumn" text="Status" prefWidth="250"/>
                        </columns>
                        <columnResizePolicy><TableView fx:constant="CONSTRAINED_RESIZE_POLICY"/></columnResizePolicy>
                    </TableView>
                </Tab>
                
                <Tab text="In Progress" closable="false">
                    <TableView fx:id="inProgressTable" styleClass="data-table">
                        <columns>
                            <TableColumn fx:id="progressNameColumn" text="Object" prefWidth="180"/>
                            <TableColumn fx:id="progressStatusColumn" text="Status" prefWidth="350"/>
                        </columns>
                        <columnResizePolicy><TableView fx:constant="CONSTRAINED_RESIZE_POLICY"/></columnResizePolicy>
                    </TableView>
                </Tab>
                
                <Tab text="Completed" closable="false">
                    <TableView fx:id="completedTable" styleClass="data-table">
                        <columns>
                            <TableColumn fx:id="completedNameColumn" text="Object" prefWidth="160"/>
                            <TableColumn fx:id="completedRecordsColumn" text="Records" prefWidth="100"/>
                            <TableColumn fx:id="completedSizeColumn" text="Size" prefWidth="90"/>
                            <TableColumn fx:id="completedTimeColumn" text="Time" prefWidth="90"/>
                        </columns>
                        <columnResizePolicy><TableView fx:constant="CONSTRAINED_RESIZE_POLICY"/></columnResizePolicy>
                    </TableView>
                </Tab>
                
                <Tab text="Errors" closable="false">
                    <TableView fx:id="errorsTable" styleClass="data-table">
                        <columns>
                            <TableColumn fx:id="errorNameColumn" text="Object" prefWidth="160"/>
                            <TableColumn fx:id="errorMessageColumn" text="Error" prefWidth="380"/>
                        </columns>
                        <columnResizePolicy><TableView fx:constant="CONSTRAINED_RESIZE_POLICY"/></columnResizePolicy>
                    </TableView>
                </Tab>
            </TabPane>
        </VBox>

        <!-- RIGHT: Configuration Panel -->
        <ScrollPane fitToWidth="true" style="-fx-background-color: transparent; -fx-background: transparent;">
            <VBox spacing="16" styleClass="content-area">
                
                <!-- Destination Panel -->
                <VBox spacing="12" styleClass="panel">
                    <Label text="Backup Destination" styleClass="panel-header"/>
                    
                    <HBox spacing="20" alignment="CENTER_LEFT">
                        <RadioButton fx:id="csvRadioButton" text="CSV Files" selected="true" styleClass="form-radio">
                            <toggleGroup><ToggleGroup fx:id="backupTargetGroup"/></toggleGroup>
                        </RadioButton>
                        <RadioButton fx:id="databaseRadioButton" text="Database" 
                                     toggleGroup="$backupTargetGroup" styleClass="form-radio"/>
                        <Region HBox.hgrow="ALWAYS"/>
                        <Button fx:id="databaseSettingsButton" text="âš™ Manage" 
                                onAction="#handleDatabaseSettings" 
                                styleClass="btn btn-ghost btn-sm" disable="true"/>
                    </HBox>
                    
                    <!-- Database Connection Selector -->
                    <VBox fx:id="connectionSelectorBox" spacing="10" visible="false" managed="false">
                        <HBox spacing="10" alignment="CENTER_LEFT">
                            <Label text="Connection:" styleClass="form-label"/>
                            <ComboBox fx:id="connectionCombo" promptText="Select a connection..." 
                                     HBox.hgrow="ALWAYS" styleClass="form-combo"/>
                            <Button text="â†»" onAction="#handleRefreshConnections" 
                                   styleClass="btn btn-ghost btn-sm">
                                <tooltip><Tooltip text="Refresh connection list"/></tooltip>
                            </Button>
                        </HBox>
                        
                        <HBox fx:id="connectionInfoBox" spacing="12" visible="false" managed="false" 
                              styleClass="callout callout-info">
                            <VBox spacing="2" HBox.hgrow="ALWAYS">
                                <Label fx:id="connectionTypeLabel" text="Snowflake" styleClass="callout-title"/>
                                <Label fx:id="connectionDetailsLabel" text="Database.Schema" styleClass="callout-text"/>
                            </VBox>
                            <Label fx:id="connectionStatusIcon" text="â—" style="-fx-text-fill: #3fb950; -fx-font-size: 18px;"/>
                        </HBox>
                    </VBox>
                    
                    <!-- CSV Output Folder -->
                    <VBox fx:id="outputFolderBox" spacing="8">
                        <Label text="Output Folder" styleClass="form-label"/>
                        <HBox spacing="8">
                            <TextField fx:id="outputFolderField" HBox.hgrow="ALWAYS" 
                                       styleClass="form-input" promptText="Select backup folder..."/>
                            <Button fx:id="browseButton" text="Browse" onAction="#handleBrowse" 
                                   styleClass="btn btn-ghost"/>
                        </HBox>
                    </VBox>
                </VBox>
                
                <!-- Options Panel -->
                <VBox spacing="12" styleClass="panel">
                    <Label text="Backup Options" styleClass="panel-header"/>
                    
                    <HBox spacing="12" alignment="CENTER_LEFT">
                        <Label text="Record Limit:" styleClass="form-label"/>
                        <TextField fx:id="recordLimitField" prefWidth="80" 
                                   styleClass="form-input" text="0"/>
                        <Label text="(0 = unlimited)" styleClass="form-hint"/>
                    </HBox>
                    
                    <!-- Custom WHERE Clause -->
                    <VBox spacing="6">
                        <HBox spacing="8" alignment="CENTER_LEFT">
                            <CheckBox fx:id="customWhereCheckbox" text="Custom WHERE Clause" 
                                      styleClass="form-checkbox" onAction="#handleCustomWhereToggle"/>
                            <Label text="(SOQL filter)" styleClass="form-hint"/>
                        </HBox>
                        <TextArea fx:id="customWhereField" prefRowCount="2" prefWidth="400"
                                  styleClass="form-input" promptText="e.g., AccountNumber != null AND CreatedDate > 2024-01-01T00:00:00Z"
                                  disable="true" wrapText="true" style="-fx-font-family: monospace; -fx-font-size: 11px;"/>
                        <Label text="Enter WHERE clause without 'WHERE' keyword. Applied to all selected objects (ignored if field doesn't exist)." 
                               styleClass="form-hint" style="-fx-padding: 0 0 0 24; -fx-wrap-text: true;"/>
                    </VBox>
                    
                    <VBox spacing="8">
                        <HBox spacing="8" alignment="CENTER_LEFT">
                            <CheckBox fx:id="incrementalBackupCheckbox" text="Incremental Backup" 
                                      styleClass="form-checkbox"/>
                            <Label fx:id="lastBackupLabel" text="" styleClass="form-hint"/>
                        </HBox>
                        <Label text="Only backup records modified since last successful backup" 
                               styleClass="form-hint" style="-fx-padding: 0 0 0 24;"/>
                    </VBox>
                    
                    <HBox spacing="8" alignment="CENTER_LEFT">
                        <CheckBox fx:id="compressBackupCheckbox" text="Compress to ZIP" 
                                  styleClass="form-checkbox"/>
                        <Label text="(saves disk space)" styleClass="form-hint"/>
                    </HBox>
                    
                    <HBox spacing="8" alignment="CENTER_LEFT">
                        <CheckBox fx:id="preserveRelationshipsCheckbox" text="Preserve Relationships" 
                                  styleClass="form-checkbox"/>
                        <Label text="(for restore)" styleClass="form-hint"/>
                    </HBox>
                    
                    <!-- Relationship-Aware Backup Options -->
                    <VBox spacing="8">
                        <HBox spacing="8" alignment="CENTER_LEFT">
                            <CheckBox fx:id="includeRelatedRecordsCheckbox" text="Include Related Records" 
                                      styleClass="form-checkbox"/>
                            <Label text="(when using record limit)" styleClass="form-hint"/>
                        </HBox>
                        <HBox spacing="8" alignment="CENTER_LEFT" style="-fx-padding: 0 0 0 24;">
                            <Label text="Depth:" styleClass="form-label"/>
                            <ComboBox fx:id="relationshipDepthCombo" prefWidth="120" styleClass="form-input" disable="true">
                                <items>
                                    <FXCollections fx:factory="observableArrayList">
                                        <String fx:value="1 - Direct children"/>
                                        <String fx:value="2 - + Grandchildren"/>
                                        <String fx:value="3 - Deep hierarchy"/>
                                    </FXCollections>
                                </items>
                            </ComboBox>
                            <CheckBox fx:id="priorityObjectsOnlyCheckbox" text="Priority objects only" 
                                      styleClass="form-checkbox" disable="true"/>
                            <Button fx:id="previewRelationshipsButton" text="ðŸ‘ Preview" 
                                    onAction="#handlePreviewRelationships" styleClass="btn btn-ghost" 
                                    style="-fx-font-size: 11px;" disable="true"/>
                        </HBox>
                        <Label text="Automatically include child records (Contacts, Opportunities, etc.) for backed-up parents" 
                               styleClass="form-hint" style="-fx-padding: 0 0 0 24;"/>
                    </VBox>
                </VBox>
                
                <!-- Progress Panel -->
                <VBox spacing="12" styleClass="panel">
                    <HBox spacing="10" alignment="CENTER_LEFT">
                        <Label fx:id="progressLabel" text="Ready to start backup" 
                               styleClass="panel-header" style="-fx-padding: 0;" HBox.hgrow="ALWAYS"/>
                        <Label fx:id="progressPercentLabel" text="0%" 
                               style="-fx-font-size: 18px; -fx-font-weight: 700; -fx-text-fill: #58a6ff;"/>
                    </HBox>
                    <ProgressBar fx:id="progressBar" maxWidth="Infinity" prefHeight="8" 
                                 styleClass="progress-bar-accent" progress="0"/>
                </VBox>
                
                <!-- Action Buttons -->
                <HBox spacing="12" alignment="CENTER">
                    <Button fx:id="startBackupButton" text="â–¶ Start Backup" onAction="#handleStartBackup" 
                            styleClass="btn btn-accent btn-lg" HBox.hgrow="ALWAYS" maxWidth="Infinity"/>
                    <Button fx:id="stopBackupButton" text="Stop" onAction="#handleStopBackup" 
                            styleClass="btn btn-danger"/>
                    <Button fx:id="exportResultsButton" text="Export" onAction="#handleExportResults" 
                            styleClass="btn btn-success" disable="true"/>
                </HBox>
                
                <!-- Activity Log -->
                <VBox spacing="8" styleClass="panel" VBox.vgrow="ALWAYS">
                    <Label text="Activity Log" styleClass="panel-header"/>
                    <TextArea fx:id="logArea" editable="false" wrapText="true" 
                              styleClass="log-area" VBox.vgrow="ALWAYS" prefHeight="150">
                        <font><Font name="Consolas" size="11"/></font>
                    </TextArea>
                </VBox>
                
            </VBox>
        </ScrollPane>
        
    </SplitPane>
</VBox>